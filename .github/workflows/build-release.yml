name: Build & Release APK

on:
  push:
    branches: [ main, master ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name:  Checkout code
      uses: actions/checkout@v4

    - name:  Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name:  Make gradlew executable
      run: chmod +x gradlew

    - name: ï¸ Build Debug APK
      run: ./gradlew assembleDebug --stacktrace --no-daemon

    - name:  Get commit info
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_OUTPUT
        echo "message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_OUTPUT

    - name:  Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.commit.outputs.date }}
        name:  Prasunet LMS - Build ${{ steps.commit.outputs.date }}
        body: |
          ##  Automated Build
          
          **Commit:** `${{ steps.commit.outputs.sha_short }}`
          **Branch:** `${{ github.ref_name }}`
          **Date:** `${{ steps.commit.outputs.date }}`
          
          ###  Latest Changes
          ```
          ${{ steps.commit.outputs.message }}
          ```
          
          ###  Installation
          1. Download `Prasunet-LMS.apk` below
          2. Enable "Install from Unknown Sources" on your Android device
          3. Install and launch the app
          
          ###  Features
          -  Student Dashboard with animated UI
          -  Mentor Course Management
          -  Admin Control Panel with Statistics
          -  Progress Tracking
          -  Modern Gradient Design
          
          **Backend:** https://prasunet.vercel.app/api
        files: app/build/outputs/apk/debug/app-debug.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name:  Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Prasunet-LMS-${{ steps.commit.outputs.date }}
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

